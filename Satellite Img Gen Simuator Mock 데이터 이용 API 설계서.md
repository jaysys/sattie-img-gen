# Satellite Img Gen Simuator Mock 데이터 이용 API 설계서

- 문서명: Satellite Img Gen Simuator Mock 데이터 이용 API 설계서
- 프로젝트: satti-sim
- 버전: v0.3
- 작성일: 2026-02-28

## 1. 목적

본 문서는 위성-지상국 통신 시뮬레이터의 목데이터 구조와 API 동작 기준을 정의한다.
목표는 다음과 같다.

- EO/SAR 위성 유형별로 일관된 촬영/산출 메타데이터 제공
- 실제 비즈니스 Tasking 흐름(요청 제약조건, 우선순위, 전송 방식) 모사
- 프런트엔드 콘솔, 외부 클라이언트, 자동화 테스트가 동일한 응답 규약 사용

## 2. 적용 범위

- 백엔드: FastAPI (`app/main.py`)
- 이미지 저장 경로: `data/images`
- 인증/제어:
  - API Key (`x-api-key`)
  - CORS (`SATTI_ALLOWED_ORIGINS`)
  - IP 기준 Rate Limit (`SATTI_RATE_LIMIT_PER_MIN`)
- API:
  - `GET /health`, `GET /`
  - `POST /satellites`, `GET /satellites`, `PATCH /satellites/{id}`, `DELETE /satellites/{id}`
  - `POST /seed/mock-satellites`
  - `GET /satellite-types`
  - `POST /uplink`
  - `GET /commands`, `GET /commands/{id}`
  - `GET /downloads/{id}`, `POST /downloads/{id}/save-local`
  - `POST /images/clear`

## 3. 보안 및 운영 규약

### 3.1 인증

- 공개 경로: `/`, `/health`, `/docs`, `/redoc`, `/openapi.json`
- 나머지 운영 API는 `x-api-key` 필요
- 실패 시: `401 Unauthorized`
- 다운로드 링크는 브라우저 직접 접근을 위해 `GET /downloads/{id}?api_key=...` 허용

### 3.2 Rate Limit

- 클라이언트 IP 기준 분당 요청 제한
- 기본값: `600` req/min
- `SATTI_RATE_LIMIT_PER_MIN<=0` 설정 시 비활성화
- 초과 시: `429 Too Many Requests`

### 3.3 CORS

- `SATTI_ALLOWED_ORIGINS` 환경변수 기반 허용 Origin 제어

## 4. 도메인 모델

### 4.1 위성 유형

- `EO_OPTICAL`
- `SAR`

### 4.2 명령 상태

- `QUEUED`
- `ACKED`
- `CAPTURING`
- `DOWNLINK_READY`
- `FAILED`

### 4.3 위성 상태

- `AVAILABLE`
- `MAINTENANCE`

## 5. API별 사용 목적과 요청/응답

모든 보호 API 호출 예시는 `x-api-key` 헤더 기준으로 작성한다.

### 5.1 `POST /seed/mock-satellites`

언제 사용하나:

- 시뮬레이터 초기 데이터(한국 위성 기반 목 위성)를 일괄 생성할 때 사용
- 이미 같은 이름의 위성이 있으면 중복 생성하지 않음

요청:

- Body 없음

응답:

- `satellite_ids`: 이번 호출에서 신규 생성된 위성 ID 목록

### 5.2 `GET /satellite-types`

언제 사용하나:

- EO/SAR별 프로파일(궤도, 모드, 기본 산출물)을 화면에 설명할 때 사용
- 업링크 UI에서 입력 제약조건 안내 기준값으로 사용

요청:

- Query/Body 없음

응답:

- `EO_OPTICAL`, `SAR` 키별 프로파일 객체

### 5.3 `POST /satellites`

언제 사용하나:

- Seed 외에 운영자가 위성을 수동 등록할 때 사용

요청:

- `name`, `type`, `status(기본 AVAILABLE)`

응답:

- `satellite_id`

### 5.4 `GET /satellites`

언제 사용하나:

- 현재 운용 가능한 위성 목록 조회
- 업링크 대상 위성 선택 전 상태 점검

요청:

- 없음

응답:

- 위성 배열 (`satellite_id`, `name`, `type`, `status`, `profile`)

### 5.5 `PATCH /satellites/{id}`

언제 사용하나:

- 위성 이름/운용상태 변경

요청:

- `name` 또는 `status`

응답:

- 수정된 위성 객체

### 5.6 `DELETE /satellites/{id}`

언제 사용하나:

- 운용대상에서 위성을 제거할 때 사용

요청:

- Path `satellite_id`

응답:

- 삭제된 위성 ID, 이름

### 5.7 `POST /uplink`

언제 사용하나:

- 지상국이 위성에 촬영 명령(Tasking)을 전송할 때 사용
- 명령 생성 후 백그라운드 파이프라인(상태전이+촬영+다운링크 준비) 자동 시작

요청 핵심 필드:

- 식별: `satellite_id`, `mission_name`, `aoi_name`
- AOI/시간: `aoi_center_lat/lon`, `aoi_bbox`, `window_open_utc`, `window_close_utc`
- 우선순위: `priority` (`BACKGROUND|COMMERCIAL|URGENT`)
- 영상 옵션: `width`, `height`, `cloud_percent`
- EO 제약: `max_cloud_cover_percent`, `max_off_nadir_deg`, `min_sun_elevation_deg`
- SAR 제약: `incidence_min_deg`, `incidence_max_deg`, `look_side`, `pass_direction`, `polarization`
- 전달 방식: `delivery_method` (`DOWNLOAD|S3|WEBHOOK`), `delivery_path`
- 생성 방식: `generation_mode` (`INTERNAL|EXTERNAL`), `external_map_source`, `external_map_zoom`
- 실패 주입: `fail_probability`

응답:

- `command_id`, 초기 `state(QUEUED)`, 위성/임무 정보, 생성시각

### 5.8 `GET /commands`

언제 사용하나:

- 최근/전체 명령 상태를 테이블로 한 번에 조회할 때 사용
- 대시보드/모니터링 화면에서 다건 상태 갱신에 사용

응답:

- `CommandStatusResponse[]`
- 각 항목에 `request_profile`, `acquisition_metadata`, `product_metadata` 포함

### 5.9 `GET /commands/{id}`

언제 사용하나:

- 특정 명령의 진행 상태를 폴링할 때 사용
- 다운로드 가능 시점(`DOWNLINK_READY`) 판정에 사용

응답:

- 명령 상세 상태
- 파일이 실제 존재할 때만 `download_url` 노출

### 5.10 `GET /downloads/{id}`

언제 사용하나:

- 다운링크 완료된 이미지 파일 직접 다운로드

응답:

- 성공: PNG 파일 스트림
- 실패:
  - `404`: 명령 없음 또는 파일 없음
  - `409`: 아직 준비 전

### 5.11 `POST /downloads/{id}/save-local`

언제 사용하나:

- 파일 다운로드 대신 서버 로컬 저장 정보(저장 경로/크기)를 확인할 때 사용

응답:

- `saved_path`, `file_size_bytes`, `message`

### 5.12 `POST /images/clear`

언제 사용하나:

- 테스트 생성 이미지를 일괄 정리할 때 사용
- `data/images` 내부 이미지 파일(`png/jpg/jpeg/webp`) 삭제 + 명령의 이미지 참조 초기화

응답:

- `deleted_count`, `cleared_command_count`, `message`

## 6. 업링크 비즈니스 필드 설계

### 6.1 AOI/시간 필드

- `aoi_center_lat`, `aoi_center_lon`: 점 기반 AOI 중심
- `aoi_bbox`: `[min_lon, min_lat, max_lon, max_lat]`
- `window_open_utc`, `window_close_utc`: ISO8601 UTC 시간창

검증:

- 중심 위경도는 반드시 쌍으로 입력
- bbox는 min < max
- 시간창은 open < close

### 6.2 EO 제약 필드

- `max_cloud_cover_percent`: 허용 최대 운량
- `max_off_nadir_deg`: 허용 최대 오프나딜
- `min_sun_elevation_deg`: 최소 태양고도

### 6.3 SAR 제약 필드

- `incidence_min_deg`, `incidence_max_deg`
- `look_side`: `ANY|LEFT|RIGHT`
- `pass_direction`: `ANY|ASCENDING|DESCENDING`
- `polarization`: 예 `VV`, `VH`

검증:

- `incidence_min_deg <= incidence_max_deg`

### 6.4 전달(Delivery) 필드

- `delivery_method`: `DOWNLOAD|S3|WEBHOOK`
- `delivery_path`: S3 경로 또는 Webhook URL

검증:

- `delivery_method`가 `S3`/`WEBHOOK`이면 `delivery_path` 필수

### 6.5 생성(Generation) 필드

- `generation_mode`: `INTERNAL|EXTERNAL`
- `external_map_source`: 현재 `OSM` 지원
- `external_map_zoom`: `1~19`

주의:

- 본 항목은 시뮬레이터 품질 검증을 위한 선택 옵션이다.
- 실제 위성 연동 운영 API에서는 필수 항목이 아니며, 기본적으로 생략 가능하다.

검증:

- `generation_mode=EXTERNAL`일 때 `aoi_center_lat/lon` 또는 `aoi_bbox` 필수

## 7. 상태 전이 및 시뮬레이션 동작

### 7.1 정상/실패 경로

- 정상: `QUEUED -> ACKED -> CAPTURING -> DOWNLINK_READY`
- 실패: 각 단계에서 `FAILED` 전이 가능

### 7.2 단계별 시간 지연(모사)

- contact window 대기: `0.7 ~ 1.8s` 후 `ACKED`
- 위성 내부 준비: `0.6 ~ 1.6s` 후 `CAPTURING`
- 촬영 소요: `1.5 ~ 3.8s` 후 완료/실패

### 7.3 실패 확률 모델

- ACK 이전 구간 실패: `fail_probability * 0.6`
- CAPTURING 이후 실패: `fail_probability * 0.4`
- 예외 발생 시 `FAILED`로 종료

## 8. 위성 유형별 메타데이터 규칙

### 8.1 EO (`EO_OPTICAL`)

`acquisition_metadata`:

| 필드 | 값 범위/형식 | 설명 |
|---|---|---|
| `captured_at` | UTC ISO8601 | 촬영 완료 시각 |
| `sensor_mode` | `NADIR \| OFF_NADIR` | 촬영 기하 모드 |
| `off_nadir_deg` | `2.0~28.0` | 오프나딜 각도 |
| `sun_elevation_deg` | `20.0~65.0` | 태양고도 |
| `cloud_cover_percent` | `0~100` | 운량 추정치 |
| `ground_track` | `ASCENDING \| DESCENDING` | 궤도 진행 방향 |
| `aoi_name` | string | AOI 이름 |
| `aoi_center` | object/null | 요청 AOI 중심 좌표 |
| `aoi_bbox` | array/null | 요청 AOI bbox |

`product_metadata`:

| 필드 | 값 범위/형식 | 설명 |
|---|---|---|
| `product_type` | `L1B_ORTHOREADY` | 기본 광학 산출물 타입 |
| `bands` | `R,G,B,NIR` | 밴드 정보 |
| `gsd_m` | `0.5~1.5` | 공간해상도 |
| `width_px` | int | 가로 픽셀 |
| `height_px` | int | 세로 픽셀 |
| `bit_depth` | `8` | 비트 심도 |
| `format` | `PNG` | 파일 포맷 |

### 8.2 SAR (`SAR`)

`acquisition_metadata`:

| 필드 | 값 범위/형식 | 설명 |
|---|---|---|
| `captured_at` | UTC ISO8601 | 촬영 완료 시각 |
| `sensor_mode` | `SPOTLIGHT \| STRIPMAP` | SAR 모드 |
| `incidence_angle_deg` | `20.0~45.0` | 입사각 |
| `look_side` | `LEFT \| RIGHT` | 관측 측면 |
| `pass_direction` | `ASCENDING \| DESCENDING` | 궤도 방향 |
| `polarization` | `VV \| VH` | 편파 |
| `aoi_name` | string | AOI 이름 |
| `aoi_center` | object/null | 요청 AOI 중심 좌표 |
| `aoi_bbox` | array/null | 요청 AOI bbox |

`product_metadata`:

| 필드 | 값 범위/형식 | 설명 |
|---|---|---|
| `product_type` | `GRD` | 기본 SAR 산출물 타입 |
| `resolution_m` | `0.8~3.0` | 유효 해상도 |
| `width_px` | int | 가로 픽셀 |
| `height_px` | int | 세로 픽셀 |
| `format` | `PNG` | 파일 포맷 |
| `speckle_filter` | `NONE \| LEE_3x3` | 노이즈 필터 |

## 9. 목 위성 시드 데이터

`POST /seed/mock-satellites` 기본 구성:

- KOMPSAT-3 (Arirang-3) - EO
- KOMPSAT-3A (Arirang-3A) - EO
- CAS500-1 (NextSat-1) - EO
- Cheollian-2B (GEO-KOMPSAT-2B) - EO
- KOMPSAT-5 (Arirang-5, SAR) - SAR
- KOMPSAT-6 (Arirang-6, SAR) - SAR
- KOMPSAT-Next-5 (C-band SAR) - SAR

## 10. 콘솔 기본값 프리셋 규칙

`Send Uplink` 화면은 위성 선택 시 입력 필드를 자동 세팅한다.

- 1순위: 시드 7개 위성 이름 기반 프리셋 적용
- 2순위: 시드 외 위성은 위성 유형(`EO_OPTICAL`/`SAR`) fallback 프리셋 적용

자동 세팅 대상:

- `mission_name`, `aoi_name`
- `aoi_center_lat/lon`, `aoi_bbox`
- `priority`
- `width`, `height`, `cloud_percent`, `fail_probability`
- EO 제약 필드, SAR 제약 필드, Delivery 필드

## 11. 저장/다운로드 정책

- 생성 이미지 저장: `data/images/{command_id}.png`
- `download_url` 노출 조건:
  - 상태가 `DOWNLINK_READY`
  - 파일이 실제로 존재
- `POST /images/clear` 실행 시:
  - 파일 삭제
  - 명령의 `image_path` 비움
  - 이후 해당 명령은 다운로드 링크 미노출

## 12. 표준 호출 예시

```bash
API_KEY='change-me'
BASE='http://127.0.0.1:6005'

curl -s -X POST "$BASE/seed/mock-satellites" -H "x-api-key: $API_KEY"
curl -s "$BASE/satellites" -H "x-api-key: $API_KEY"

curl -s -X POST "$BASE/uplink" \
  -H "x-api-key: $API_KEY" \
  -H 'Content-Type: application/json' \
  -d '{
    "satellite_id":"sat-xxxxxxxx",
    "mission_name":"harbor-monitoring",
    "aoi_name":"incheon-port",
    "aoi_center_lat":37.45,
    "aoi_center_lon":126.62,
    "window_open_utc":"2026-02-28T01:00:00Z",
    "window_close_utc":"2026-02-28T03:00:00Z",
    "priority":"URGENT",
    "max_cloud_cover_percent":25,
    "delivery_method":"DOWNLOAD",
    "fail_probability":0.05
  }'

curl -s "$BASE/commands" -H "x-api-key: $API_KEY"
curl -L "$BASE/downloads/cmd-xxxxxxxxxxxx?api_key=$API_KEY" -o result.png
curl -s -X POST "$BASE/images/clear" -H "x-api-key: $API_KEY"
```

## 13. 향후 확장

- AOI 폴리곤(GeoJSON) 직접 입력 지원
- Contact window 계산 로직 고도화(TLE 기반)
- 산출물 포맷 확대(GeoTIFF/COG)
- Delivery 실동작(S3 업로드/Webhook 전송) 시뮬레이션 분리
